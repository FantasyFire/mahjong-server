<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>测试客户端</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font: 13px Helvetica, Arial; }
        form { background: #000; padding: 3px; position: fixed; bottom: 0; width: 100%; }
        form input { border: 0; padding: 10px; width: 90%; margin-right: .5%; }
        form button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }
        #messages { list-style-type: none; margin: 0; padding: 0; }
        #messages li { padding: 5px 10px; }
        #messages li:nth-child(odd) { background: #eee; }
    </style>
    <link rel="stylesheet" type="text/css" href='css/style.css'/>
</head>
<script src="lib/socket.io.js"></script>
<script src="lib/jquery-1.11.1.js"></script>
<script src="js/component.js"></script>
<body>
    <div class="mahjongTable">
        <div id="player1" class="playerTable"></div>
        <div id="player2" class="playerTable"></div>
        <div id="player3" class="playerTable"></div>
        <div id="player4" class="playerTable"></div>
    </div>
</body>
<script>
    // 可执行动作码
    const ActionCode = {
        ZiMo: 128, // 自摸
        DianPao: 64, // 点炮
        Hu: 192, // 胡
        AnGang: 32, // 暗杠
        MingGang: 16, // 明杠
        PengHouGang: 8, // 碰后杠
        Gang: 56, // 杠
        Peng: 4, // 碰
        Chi: 2, // 吃
        Pass: 1 // 过
    };

    var socket = null, currentPlayerId = "", state = "", gameData = null;
    $(function () {
        socket = io();
        socket.on('news', onNews);
    });
1
    function onNews(msg) {
        console.log(`收到消息：${msg}`);
        let json = gameData = JSON.parse(msg);
        currentPlayerId = json.tableData.currentPlayerId;
        state = json.tableData.state;
        for (let player in json.playerDatas) {
            let wrapper = document.querySelector('#'+player);
            let playerData = json.playerDatas[player];
            playerData.id = player;
            renderPlayerData(wrapper, playerData, player==currentPlayerId);
        }
    }

    function renderPlayerData(wrapper, playerData, canPlayCard) {
        let str = "";
        // TODO: player information (headImage nickname etc.)
        str += renderPlayerInfo(playerData);
        // played cards
        str += renderCardGroup('playedCards', playerData.playedCards||[]);
        str += '<div class="wrapper">';
            // actionDetail
            str += renderCardGroup(playerData.id + '_actionDetail', []);
            // playCard
            str += renderCardGroup('playCard', playerData.playCard||[]);
            // action
            str += renderActionCode(playerData.id, playerData.actionCode);
        str += '</div>';
        str += '<div class="wrapper">';
            // TODO: 这里只处理了card，未处理from信息。数据结构：{card:[n,n,n],from:"xxxx"}
            playerData.groupCards.forEach(gc => {
                let cards = gc.card;
                // TODO: 这里应详细区分各种杠
                if (gc.actionCode&ActionCode.Gang) cards = Array(4).fill(gc.card);
                if (gc.actionCode&ActionCode.Peng) cards = Array(3).fill(gc.card);
                str += renderCardGroup('groupCards', cards);
            });
            // hand cards
            str += renderCardGroup('handCards', playerData.handCards, canPlayCard ? 0 : undefined);
            // new card
            if (playerData.newCard) {
                str += renderCardGroup('newCard', playerData.newCard, playerData.handCards.length);
            }
        str += '</div>';
        $(wrapper).html(str);
    }

    function renderCard(number, index) {
        return `
            <div class="card" ${index==undefined ? "" : `onclick="playCard(${index})"`} style="background-color:#${['f99','9f9','99f','fff','fff'][number2index(number)]}">
                <div class="text">${number2text(number)}</div>
            </div>
        `;
    }

    function renderCardGroup(id, cards, starti) {
        cards = [].concat(cards);
        return `
            <div id="${id}" class="card-group">
                ${cards.map((n, i) => renderCard(n, starti==undefined ? undefined : starti+i)).join('')}
            </div>
        `;
    }

    const type2text = {1:"万", 3:"条", 5:"筒", 7:"风", 9:""};
    const feng2text = {0:"东", 3:"南", 6:"西", 9:"北"};
    const jian2text = {0:"中", 3:"发", 6:"白"};
    function number2text(number) {
        let type = ~~(number/10), n = number%10, text = "";
        if (type <= 5) {
            text = n;
        } else if (type == 7) {
            text = feng2text[n];
        } else if (type == 9) {
            text = jian2text[n];
        }
        return text + type2text[type];
    }

    // 数字映射到牌类的序号（万：0，条：1，筒：2，风：3，箭：4）
    function number2index(number) {
        return number < 30 ? 0 : number < 50 ? 1 : number < 70 ? 2 : number < 90 ? 3 : 4;
    }

    // actionCode 映射 后端接受的api名
    const actionCode2actionApi = {1:"pass", 2:"chi", 4:"peng", 8:"gang", 16:"gang", 32: "gang", 56:"gang", 64:"hu", 128:"hu", 192:"hu"};
    const actionCode2text = {1:"过", 2:"吃", 4:"碰", 56:"杠", 192:"胡"};
    function renderActionCode(playerId, actionCode) {
        let actionArray = [];
        // 解析出蕴含的actionCode
        for (let ac in actionCode2text) (actionCode&(ac*1))!=0 && actionArray.push(actionCode&(ac*1));
        actionArray.reverse();
        return `
            <div id="${playerId}_actionCodeGroup" class="action-group">
                ${actionArray.map(ac => renderAction(playerId, ac)).join('')}
            </div>
        `;
    }

    function renderAction(playerId, actionCode) {
        let actionText = '', onclick = '';
        // TODO: 点击事件
        // 吃、杠，弹出选择列表
        if (actionCode&ActionCode.Chi || actionCode&ActionCode.Gang) {
            onclick = `showActionDetail('${playerId}',${actionCode});$('#${playerId}_actionCodeGroup').html('')`;
        } else {
            onclick = `doAction('${playerId}',${actionCode},'')`;
        }
        // 找到actionCode对应的文本
        for (let ac in actionCode2text) {
            if ((actionCode&(ac*1))!=0) {
                actionText = actionCode2text[ac];
                break;
            }
        }
        return `
            <div class="action" onclick="${onclick}"><span class="action-text">${actionText}</span></div>
        `;
    }

    function renderPlayerInfo(playerData) {
        return `
            <div class="wrapper" ${currentPlayerId==playerData.id?'style="font-weight:bold;color:#f00"':''}>${playerData.id}</div>
        `;
    }

    // 打一张牌动作请求
    function playCard(index) {
        let msg = JSON.stringify({playerId: currentPlayerId, action:"playCard", data:index});
        console.log('发送消息: ', msg)
        socket.emit('chat message', msg);
    }

    // 发起动作请求（不包括打牌）
    function doAction(playerId, actionCode, data) {
        let msg = JSON.stringify({playerId, action:actionCode2actionApi[actionCode], data});
        console.log('发送消息: ', msg)
        socket.emit('chat message', msg);
    }

    // 展示吃/杠选择
    function showActionDetail(playerId, actionCode) {
        let playerData = gameData.playerDatas[playerId];
        let content = '';
        if (actionCode&ActionCode.Chi) content = renderChiList(playerId, playerData.chiList);
        if (actionCode&ActionCode.Gang) content = renderGangList(playerId, playerData.gangList);
        $('#'+playerId+'_actionDetail').html(content);
    }
    function renderChiList(playerId, chiList) {
        return chiList.map((c, i) => `<div class="action-detail-group-wrapper"><div class="clickLayer" onclick="doAction('${playerId}',${ActionCode.Chi},${i})"></div>${renderCardGroup(`chi_${i}`, c)}</div>`);
    }

    function renderGangList(playerId, gangList) {
        return gangList.map((c, i) => `<div class="action-detail-group-wrapper"><div class="clickLayer" onclick="doAction('${playerId}',${ActionCode.Gang},${i})"></div>${renderCardGroup(`gang_${i}`, c)}</div>`);
    }
</script>
</html>